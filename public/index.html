<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="streamdy.PNG">
    <title>Lễ Tốt nghiệp - Giới (9h30 27/09) </title>
    <meta name="description" content="Lễ Tốt nghiệp - Giới (9h30-11h 04/10) tại Hội trường C2, ĐHBK Hà Nội.">
    <meta property="og:type"        content="website">
  <meta property="og:url"         content="https://streamdy.com">
  <meta property="og:title"       content="Lễ Tốt nghiệp - Giới (9h 04/10)">
  <meta property="og:description" content="Lễ Tốt nghiệp - Giới (9h-11h 04/10) tại Hội trường C2, ĐHBK Hà Nội.">
  <meta property="og:image"       content="https://i.postimg.cc/Qd89mB1y/Screenshot-2025-09-21-at-18-07-11-1.png">
  <meta property="og:image:width" content="1112">
  <meta property="og:image:height"content="630">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            padding: 20px;
            overflow-x: auto;
        }

        .terminal {
            max-width: 800px;
            margin: 0 auto;
        }

        .ascii-art {
            font-size: 8px;
            line-height: 1;
            white-space: pre;
            margin-bottom: 20px;
            color: #00ff00;
        }

        .command-line {
            margin: 10px 0;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        .prompt {
            color: #ffff00;
            display: inline;
        }

        .command {
            color: #00ffff;
        }

        .output {
            margin: 10px 0 20px 0;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        .success {
            color: #00ff00;
        }

        .info {
            color: #00aaff;
        }

        .warning {
            color: #ff9900;
        }

        .event-details {
            background: #111;
            border: 1px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
        }

        .icon {
            font-size: 20px;
            width: 30px;
        }

        .label {
            font-weight: bold;
            min-width: 80px;
        }

        .value {
            color: #ffffff;
        }

        .map-link {
            color: #00ffff;
            text-decoration: underline;
            cursor: pointer;
        }

        .map-link:hover {
            color: #ffff00;
        }

        .button {
            background: #001100;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            margin: 10px 5px;
            border-radius: 3px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .button:hover {
            background: #00ff00;
            color: #000;
        }

        .decline-btn {
            background: #110000 !important;
            border-color: #ff0000 !important;
            color: #ff0000 !important;
        }

        .decline-btn:hover {
            background: #ff0000 !important;
            color: #000 !important;
            animation: shake 0.5s;
        }

        .stolen-btn {
            position: absolute !important;
            pointer-events: none !important;
            opacity: 0.5 !important;
            transform: translateX(200px) !important;
            transition: all 0.3s ease !important;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .terminal-warning {
            background: #220000;
            border-left: 4px solid #ff0000;
            padding: 10px;
            margin: 10px 0;
            animation: blink-red 1s infinite;
        }

        @keyframes blink-red {
            0%, 50% { background: #220000; }
            51%, 100% { background: #330000; }
        }

        .guestbook {
            margin-top: 30px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .guestbook input {
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: inherit;
            border-radius: 3px;
        }

        .guestbook input:focus,
        .guestbook textarea:focus {
            outline: none;
            border-color: #ffff00;
            box-shadow: 0 0 5px #00ff00;
        }

        .typing {
            display: inline-block;
            animation: typing 3s steps(30) 1s forwards, blink 1s infinite;
            white-space: nowrap;
            overflow: hidden;
            border-right: 2px solid #00ff00;
            width: 0;
        }

        @keyframes typing {
            to { width: 100%; }
        }

        @keyframes blink {
            0%, 50% { border-color: #00ff00; }
            51%, 100% { border-color: transparent; }
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .command-line:nth-child(1) { animation-delay: 0s; }
        .command-line:nth-child(2) { animation-delay: 1s; }
        .command-line:nth-child(3) { animation-delay: 2s; }
        .command-line:nth-child(4) { animation-delay: 3s; }
        .command-line:nth-child(5) { animation-delay: 4s; }
        .output:nth-child(6) { animation-delay: 5s; }

        /* Live Location/Map Styles */
        .live-location {
            background: #001122;
            border: 2px solid #00aaff;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }

        .live-location.active {
            border-color: #00ff00;
            background: #002200;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 170, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 170, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 170, 255, 0); }
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); }
        }

        .location-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            animation: blink 1s infinite;
        }

        .status-dot.active {
            background: #00ff00;
        }

        .location-sharing {
            background: #002211;
            border: 2px solid #00ff88;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .map-container {
            margin: 15px 0;
            border: 2px solid #00ff00;
            border-radius: 5px;
            overflow: hidden;
            background: #111;
        }

        .map-container iframe {
            width: 100%;
            height: 300px;
            border: none;
            filter: invert(90%) hue-rotate(180deg);
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .map-button {
            background: #003300;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            transition: all 0.3s;
        }

        .map-button:hover {
            background: #00ff00;
            color: #000;
        }

        .map-button:active {
            transform: scale(0.98);
        }

        @media (max-width: 600px) {
            .ascii-art {
                font-size: 6px;
            }
            
            body {
                padding: 10px;
                font-size: 12px;
            }
            
            .event-details {
                padding: 15px;
            }
            
            .detail-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .map-controls {
                flex-direction: column;
            }

            .map-button {
                width: 100%;
                text-align: center;
            }

            .map-container iframe {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="terminal">
        <div class="ascii-art">
 ____  ___  __      __  ___   ____  __  ____ _________  ____   ____  
/  _ \|   ||  |__  |  ||   \ |    \|  ||  __|_   _|_  \|    \ /    | 
|  | ||   ||  ___| |  ||    \|  D  )  ||  _|  | |   | ||  D  )   __| 
|  |_||___||  |    |  ||  D  |    /|  ||  |   | |   | ||    /|  |_  
|     |    |__|    |__||_____|___|_|__||__|   |_|   |_||___|_\|_____|
        </div>

        <div class="command-line">
            <span class="prompt">$ </span>
            <span class="command typing">./graduation.sh --ceremony="Class of 2025"</span>
        </div>

        <div class="command-line">
            <span class="prompt">[] </span>
            <span class="info">INFO</span>
        </div>

        <div class="command-line">
            <span class="success">Đăng nhập thành công!</span>
        </div>

        <div class="command-line">
            <span class="prompt">[] </span>
            <span class="success">SUCCESS</span>
        </div>

        <div class="output">
            <h2 style="color: #ffff00; margin-bottom: 20px;">Thân mời bạn đến tham dự:</h2>
            <h1 style="color: #00ffff; margin-bottom: 30px; font-size: 24px;">Lễ Tốt nghiệp của Giới</h1>
            
            <div class="event-details">
                <div class="detail-row">
                    <span class="icon">📅</span>
                    <span class="label">Thời gian:</span>
                    <div class="value">
                        <div>09:00 - 11:00</div>
                        <div>04/10/2025</div>
                    </div>
                </div>
                
                <div class="detail-row">
                    <span class="icon">📍</span>
                    <span class="label">Địa điểm:</span>
                    <div class="value">
                        <div>Hội trường C2</div>
                        <div>Đại học Bách khoa Hà Nội</div>
                        <div><a href="https://maps.app.goo.gl/ZSpb4NJHbXPJ5SrM6" class="map-link">Click để mở Google Maps</a></div>
                    </div>
                </div>
            </div>

            <!-- Live Location/Map Section -->
            <div class="live-location" id="liveLocationSection">
                <div class="location-status">
                    <span class="status-dot" id="statusDot"></span>
                    <h3 style="color: #00aaff;">🗺️ BẢN ĐỒ VỊ TRÍ CỦA GIỚI</h3>
                </div>
                
                <div id="locationContent">
                    <div class="info">🔄 Chưa có bản đồ vị trí. Giới sẽ chia sẻ vào ngày lễ tốt nghiệp.</div>
                </div>

                <!-- Map Container -->
                <div class="map-container" id="mapContainer" style="display: none;">
                    <iframe id="mapIframe" 
                            src="" 
                            allowfullscreen="" 
                            loading="lazy" 
                            referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>

                <!-- Location Controls (for host) -->
           <!--    <div class="location-sharing" id="locationSharing" style="display: none;">
                    <h4 style="color: #00ff88; margin-bottom: 10px;">🎓 ĐIỀU KHIỂN BẢN ĐỒ (CHỈ CHỦ LỄ)</h4>
                    <div style="margin-bottom: 10px;">
                        <input type="password" id="adminKey" placeholder="Nhập mật khẩu admin" 
                               style="width: 200px; padding: 5px; background: #000; border: 1px solid #00ff00; color: #00ff00; margin-bottom: 5px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="mapLocationInput" placeholder="Nhập địa điểm (VD: Hội trường C2, ĐHBK Hà Nội)" 
                               style="width: 100%; padding: 5px; background: #000; border: 1px solid #00ff00; color: #00ff00; margin-bottom: 5px;">
                        <div style="color: #666; font-size: 11px;">
                            Ví dụ: "Hội trường C2, Đại học Bách khoa Hà Nội" hoặc "Quảng trường C1, HUST"
                        </div>
                    </div>
                    <div class="map-controls">
                        <button class="map-button" onclick="showMap()">🗺️ Hiển thị bản đồ</button>
                        <button class="map-button" onclick="hideMap()">❌ Ẩn bản đồ</button>
                        <button class="map-button" onclick="useCurrentLocation()">📍 Vị trí hiện tại</button>
                        <button class="map-button" onclick="toggleControls()">⚙️ Ẩn/Hiện panel</button>
                    </div>
                    <div id="locationStatus" style="margin-top: 10px; color: #ffff00; font-size: 12px;"></div>
                </div>-->
            </div>

            <div style="margin: 20px 0;">
                <p style="color: #ffff00;">Nhấn "Đồng ý" và viết lưu bút cho mình bên dưới nhé!</p>
            </div>

            <div class="buttons">
                <button class="button" onclick="confirmAttendance()">Đồng ý tham dự</button>
                <button class="button decline-btn" id="declineBtn" onclick="declineAttendance()">Từ chối</button>
            </div>

            <div class="warning" style="margin-top: 20px;">
                <h3>Lưu ý:</h3>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Hãy đứng chờ mình quanh quảng trường C1 và gọi điện thoại để biết mình ở đâu nhé.</li>
                    <li>Mình sẽ chia sẻ bản đồ vị trí trực tiếp ở phần bên trên vào buổi lễ tốt nghiệp.</li>
                    <li>SĐT: 0374348370</li>
                </ul>
            </div>

            <div class="guestbook" id="guestbook" style="display: none;">
                <h3 style="color: #00ffff; margin-bottom: 15px;">📝 Lưu bút cho Giới</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="color: #ffff00; display: block; margin-bottom: 5px;">TÊN CỦA BAN:</label>
                    <input type="text" id="guestName" placeholder="Nhập tên của ban" style="width: 100%; padding: 8px; background: #000; border: 1px solid #00ff00; color: #00ff00; font-family: inherit;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="color: #ffff00; display: block; margin-bottom: 5px;">NHẬP LỜI NHẮN:</label>
                    <textarea id="guestMessage" placeholder="Nhập lời nhắn cho Giới..." style="width: 100%; height: 100px; background: #000; border: 1px solid #00ff00; color: #00ff00; font-family: inherit; padding: 10px; resize: vertical;"></textarea>
                </div>
                
                <div style="text-align: center;">
                    <button class="button" onclick="submitGuestbook()">GỬI</button>
                    <button class="button" style="background: #331100; border-color: #ff6600; color: #ff6600;" onclick="cancelGuestbook()">HỦY</button>
                </div>
            </div>

            <div class="command-line" style="margin-top: 30px;">
                <span class="prompt">$ </span>
                <span class="command">rsvp --confirm --guests=1</span>
                <span style="animation: blink 1s infinite;">_</span>
            </div>
        </div>
    </div>

    <script>
        let declineAttempts = 0;
        let isMapVisible = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('locationSharing').style.display = 'block';
            
            // Check for existing shared map from server
            checkSharedMapStatus();
            
            // Poll for map updates every 10 seconds
            setInterval(checkSharedMapStatus, 10000);
        });

        // Check shared map status from server
        async function checkSharedMapStatus() {
            try {
                // This would normally fetch from your /api/live-location endpoint
                const response = await fetch('/api/live-location');
                
                if (response.ok) {
                    const data = await response.json();
                    updateMapFromServer(data);
                } else {
                    console.log('No shared map data available');
                }
            } catch (error) {
                // Silently handle error - server might not be available
                console.log('Could not check map status:', error.message);
            }
        }

        // Update map display based on server data
        function updateMapFromServer(data) {
            if (data.isActive && data.mapUrl) {
                // Show shared map to all users
                document.getElementById('mapIframe').src = data.mapUrl;
                document.getElementById('mapContainer').style.display = 'block';
                document.getElementById('statusDot').classList.add('active');
                document.getElementById('liveLocationSection').classList.add('active');
                
                document.getElementById('locationContent').innerHTML = `
                    <div class="success">🟢 Giới đang chia sẻ vị trí trực tiếp!</div>
                    <div style="margin: 10px 0;">
                        <div style="color: #ffffff;">📍 ${data.description || 'Vị trí hiện tại'}</div>
                        <div style="color: #00aaff; font-size: 12px; margin-top: 5px;">
                            📞 ${data.phone || '0374348370'} | ⏰ Cập nhật: ${data.timestamp ? new Date(data.timestamp).toLocaleTimeString('vi-VN') : 'N/A'}
                        </div>
                        ${data.note ? `<div style="color: #ffff00; margin-top: 5px;">💡 ${data.note}</div>` : ''}
                    </div>
                `;
                
                isMapVisible = true;
            } else {
                // Hide map for all users
                document.getElementById('mapContainer').style.display = 'none';
                document.getElementById('statusDot').classList.remove('active');
                document.getElementById('liveLocationSection').classList.remove('active');
                
                document.getElementById('locationContent').innerHTML = `
                    <div class="info">🔄 Chưa có bản đồ vị trí. Giới sẽ chia sẻ vào ngày lễ tốt nghiệp.</div>
                `;
                
                isMapVisible = false;
            }
        }
        // Map control functions  
        async function showMap() {
            const adminKey = document.getElementById('adminKey').value;
            const location = document.getElementById('mapLocationInput').value;

            if (!adminKey) {
                updateLocationStatus('⚠️ Vui lòng nhập mật khẩu admin!');
                return;
            }

            if (!location.trim()) {
                updateLocationStatus('⚠️ Vui lòng nhập địa điểm!');
                return;
            }

            updateLocationStatus('🔄 Đang chia sẻ bản đồ với tất cả người dùng...');

            try {
                // Create Google Maps embed URL
                const encodedLocation = encodeURIComponent(location.trim());
                // Use basic embed URL that works without API key
                const mapUrl = `https://maps.google.com/maps?q=${encodedLocation}&t=&z=16&ie=UTF8&iwloc=&output=embed`;

                // Send to server to share with all users
                const locationData = {
                    adminKey: adminKey,
                    isActive: true,
                    description: location.trim(),
                    mapUrl: mapUrl,
                    phone: '0374348370',
                    note: 'Vị trí được chia sẻ từ admin'
                };

                const response = await fetch('/api/share-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Update local display immediately
                    document.getElementById('mapIframe').src = mapUrl;
                    document.getElementById('mapContainer').style.display = 'block';
                    document.getElementById('statusDot').classList.add('active');
                    document.getElementById('liveLocationSection').classList.add('active');
                    
                    document.getElementById('locationContent').innerHTML = `
                        <div class="success">🟢 Bản đồ đã được chia sẻ với tất cả người dùng!</div>
                        <div style="margin: 10px 0;">
                            <div style="color: #ffffff;">📍 Vị trí: ${location}</div>
                            <div style="color: #00aaff; font-size: 12px; margin-top: 5px;">
                                📞 0374348370 | ⏰ Cập nhật: ${new Date().toLocaleTimeString('vi-VN')}
                            </div>
                            <div style="color: #ffff00; margin-top: 5px;">🌐 Đã đồng bộ với tất cả người truy cập streamdy.com</div>
                        </div>
                    `;

                    isMapVisible = true;
                    updateLocationStatus('✅ Bản đồ đã được chia sẻ với tất cả người dùng!');
                    addTerminalMessage('SUCCESS', `🗺️ Bản đồ "${location}" đã được chia sẻ trực tiếp với tất cả người dùng!`);
                    
                } else {
                    throw new Error('Không thể kết nối server để chia sẻ bản đồ');
                }

            } catch (error) {
                // Fallback to local display if server fails
                console.error('Server error:', error);
                
                const encodedLocation = encodeURIComponent(location.trim());
                const mapUrl = `https://maps.google.com/maps?q=${encodedLocation}&t=&z=16&ie=UTF8&iwloc=&output=embed`;
                
                document.getElementById('mapIframe').src = mapUrl;
                document.getElementById('mapContainer').style.display = 'block';
                document.getElementById('statusDot').classList.add('active');
                document.getElementById('liveLocationSection').classList.add('active');
                
                document.getElementById('locationContent').innerHTML = `
                    <div class="warning">🟡 Bản đồ hiển thị cục bộ (lỗi server)</div>
                    <div style="margin: 10px 0;">
                        <div style="color: #ffffff;">📍 Vị trí: ${location}</div>
                        <div style="color: #ff9900; font-size: 12px; margin-top: 5px;">
                            ⚠️ Chỉ hiển thị trên thiết bị này - server không khả dụng
                        </div>
                    </div>
                `;

                updateLocationStatus('⚠️ Hiển thị cục bộ - lỗi kết nối server');
                addTerminalMessage('WARNING', `🗺️ Bản đồ "${location}" chỉ hiển thị cục bộ (lỗi server)`);
            }

            // Scroll to map
            document.getElementById('mapContainer').scrollIntoView({ behavior: 'smooth' });
        }

        async function hideMap() {
            const adminKey = document.getElementById('adminKey').value;

            if (!adminKey) {
                updateLocationStatus('⚠️ Vui lòng nhập mật khẩu admin!');
                return;
            }

            updateLocationStatus('🔄 Đang ẩn bản đồ cho tất cả người dùng...');

            try {
                // Send to server to hide map for all users
                const response = await fetch('/api/share-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        adminKey: adminKey,
                        isActive: false,
                        description: '',
                        mapUrl: '',
                        phone: '0374348370',
                        note: ''
                    })
                });

                if (response.ok) {
                    // Update local display
                    document.getElementById('mapContainer').style.display = 'none';
                    document.getElementById('statusDot').classList.remove('active');
                    document.getElementById('liveLocationSection').classList.remove('active');
                    
                    document.getElementById('locationContent').innerHTML = `
                        <div class="warning">🔴 Bản đồ đã được ẩn khỏi tất cả người dùng</div>
                        <div style="color: #888; margin-top: 5px;">
                            Giới đã dừng chia sẻ vị trí. Hãy gọi điện để biết vị trí chính xác!
                        </div>
                    `;

                    isMapVisible = false;
                    updateLocationStatus('⏹️ Đã ẩn bản đồ cho tất cả người dùng');
                    addTerminalMessage('WARNING', '❌ Bản đồ vị trí đã được ẩn khỏi tất cả người dùng');
                    
                } else {
                    throw new Error('Không thể kết nối server');
                }
                
            } catch (error) {
                // Fallback to local hide if server fails
                console.error('Server error:', error);
                
                document.getElementById('mapContainer').style.display = 'none';
                document.getElementById('statusDot').classList.remove('active');
                document.getElementById('liveLocationSection').classList.remove('active');
                
                document.getElementById('locationContent').innerHTML = `
                    <div class="warning">🟡 Bản đồ ẩn cục bộ (lỗi server)</div>
                    <div style="color: #ff9900; margin-top: 5px;">
                        ⚠️ Chỉ ẩn trên thiết bị này - server không khả dụng
                    </div>
                `;

                updateLocationStatus('⚠️ Ẩn cục bộ - lỗi kết nối server');
                addTerminalMessage('WARNING', '❌ Bản đồ chỉ ẩn cục bộ (lỗi server)');
            }
        }

        async function useCurrentLocation() {
            const adminKey = document.getElementById('adminKey').value;

            if (!adminKey) {
                updateLocationStatus('⚠️ Vui lòng nhập mật khẩu admin!');
                return;
            }

            if (!navigator.geolocation) {
                updateLocationStatus('❌ Trình duyệt không hỗ trợ định vị GPS');
                return;
            }

            updateLocationStatus('📍 Đang lấy vị trí hiện tại...');

            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);

                    updateLocationStatus('🔄 Đang chia sẻ vị trí GPS với tất cả người dùng...');

                    try {
                        // Create map with current location
                        const mapUrl = `https://maps.google.com/maps?q=${lat},${lng}&t=&z=16&ie=UTF8&iwloc=&output=embed`;
                        
                        // Send to server to share with all users
                        const locationData = {
                            adminKey: adminKey,
                            isActive: true,
                            description: `Tọa độ GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                            mapUrl: mapUrl,
                            phone: '0374348370',
                            note: `Vị trí GPS trực tiếp (±${accuracy}m)`
                        };

                        const response = await fetch('/api/share-location', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(locationData)
                        });

                        if (response.ok) {
                            // Update local display
                            document.getElementById('mapIframe').src = mapUrl;
                            document.getElementById('mapContainer').style.display = 'block';
                            document.getElementById('statusDot').classList.add('active');
                            document.getElementById('liveLocationSection').classList.add('active');
                            
                            document.getElementById('locationContent').innerHTML = `
                                <div class="success">🟢 Vị trí GPS đã được chia sẻ với tất cả người dùng!</div>
                                <div style="margin: 10px 0;">
                                    <div style="color: #ffffff;">📍 Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                                    <div style="color: #00aaff; font-size: 12px; margin-top: 5px;">
                                        📞 0374348370 | 🎯 Độ chính xác: ~${accuracy}m | ⏰ ${new Date().toLocaleTimeString('vi-VN')}
                                    </div>
                                    <div style="color: #ffff00; margin-top: 5px;">🌐 Vị trí GPS trực tiếp - đã đồng bộ với tất cả người dùng</div>
                                </div>
                            `;

                            // Also update input field for reference
                            document.getElementById('mapLocationInput').value = `${lat},${lng}`;

                            isMapVisible = true;
                            updateLocationStatus('✅ Vị trí GPS đã được chia sẻ với tất cả người dùng!');
                            addTerminalMessage('SUCCESS', `📍 Vị trí GPS hiện tại đã được chia sẻ trực tiếp với tất cả người dùng (±${accuracy}m)`);
                            
                        } else {
                            throw new Error('Không thể kết nối server để chia sẻ vị trí GPS');
                        }

                    } catch (error) {
                        // Fallback to local display if server fails
                        console.error('Server error:', error);
                        
                        const mapUrl = `https://maps.google.com/maps?q=${lat},${lng}&t=&z=16&ie=UTF8&iwloc=&output=embed`;
                        document.getElementById('mapIframe').src = mapUrl;
                        document.getElementById('mapContainer').style.display = 'block';
                        document.getElementById('statusDot').classList.add('active');
                        document.getElementById('liveLocationSection').classList.add('active');
                        
                        document.getElementById('locationContent').innerHTML = `
                            <div class="warning">🟡 Vị trí GPS hiển thị cục bộ (lỗi server)</div>
                            <div style="margin: 10px 0;">
                                <div style="color: #ffffff;">📍 Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                                <div style="color: #ff9900; font-size: 12px; margin-top: 5px;">
                                    ⚠️ Chỉ hiển thị trên thiết bị này - server không khả dụng
                                </div>
                            </div>
                        `;

                        document.getElementById('mapLocationInput').value = `${lat},${lng}`;

                        updateLocationStatus('⚠️ Hiển thị GPS cục bộ - lỗi kết nối server');
                        addTerminalMessage('WARNING', `📍 Vị trí GPS chỉ hiển thị cục bộ (lỗi server) - ±${accuracy}m`);
                    }

                    // Scroll to map
                    document.getElementById('mapContainer').scrollIntoView({ behavior: 'smooth' });
                },
                function(error) {
                    let message = 'Không thể lấy vị trí';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Quyền truy cập vị trí bị từ chối';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Vị trí không khả dụng';
                            break;
                        case error.TIMEOUT:
                            message = 'Timeout khi lấy vị trí';
                            break;
                    }
                    updateLocationStatus(`❌ Lỗi: ${message}`);
                    addTerminalMessage('ERROR', `❌ ${message}. Hãy nhập địa điểm thủ công.`);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function toggleControls() {
            const locationSharing = document.getElementById('locationSharing');
            const isVisible = locationSharing.style.display !== 'none';
            locationSharing.style.display = isVisible ? 'none' : 'block';
            
            if (isVisible) {
                addTerminalMessage('INFO', '⚙️ Panel điều khiển đã được ẩn');
            } else {
                addTerminalMessage('INFO', '⚙️ Panel điều khiển đã được hiển thị');
            }
        }

        function updateLocationStatus(message) {
            document.getElementById('locationStatus').textContent = message;
        }

        // Original functions remain the same
        function confirmAttendance() {
            const declineBtn = document.getElementById('declineBtn');
            declineBtn.classList.remove('stolen-btn');
            declineBtn.style.display = 'inline-block';
            
            document.getElementById('guestbook').style.display = 'block';
            document.getElementById('guestbook').scrollIntoView({ behavior: 'smooth' });
            
            const rsvpSection = document.querySelector('.command-line:last-child');
            rsvpSection.innerHTML = '<span class="prompt">$ </span><span class="command">rsvp --confirm --guests=1</span>';
        }

        function declineAttendance() {
            declineAttempts++;
            const terminal = document.querySelector('.terminal');
            const declineBtn = document.getElementById('declineBtn');
            
            const warnings = [
                '🚨 ALERT: Decline button has been STOLEN! 🚨',
                '⚠️ A sketchy figure is running away with the decline button!',
                '🏃 *running sounds* 🔊',
                '⚠️ The thief is getting away! 🏃💨',
                '⚠️ Button thief is almost gone! 🏃💨💨',
                '🔍 Police report: Button thief escaped!',
                '✅ A new decline button has been deployed!',
                '⚠️ WARNING: This button may also be stolen! 😂'
            ];

            if (declineAttempts === 1) {
                addTerminalMessage('INFO', '🎉 Hãy đến để chúc mừng Giới thoát khỏi server HUST! 🎉');
                addTerminalMessage('ERROR', warnings[0], 'terminal-warning');
                addTerminalMessage('WARNING', warnings[1]);
                
                setTimeout(() => {
                    addTerminalMessage('INFO', warnings[2]);
                    declineBtn.classList.add('stolen-btn');
                }, 1000);
                
                setTimeout(() => addTerminalMessage('WARNING', warnings[4]), 3000);
                setTimeout(() => addTerminalMessage('INFO', warnings[5]), 4000);
                setTimeout(() => {
                    addTerminalMessage('SUCCESS', warnings[6]);
                    declineBtn.classList.remove('stolen-btn');
                    declineBtn.style.display = 'inline-block';
                }, 5000);
                setTimeout(() => addTerminalMessage('WARNING', warnings[7]), 6000);
                
            } else if (declineAttempts === 2) {
                addTerminalMessage('ERROR', '🚨 ALERT: Decline button has been STOLEN AGAIN! 🚨', 'terminal-warning');
                addTerminalMessage('WARNING', '🕵️ A professional button thief has arrived!');
                addTerminalMessage('INFO', '💨 *whoosh sounds* The button disappeared!');
                
                declineBtn.style.display = 'none';
                
                setTimeout(() => {
                    addTerminalMessage('INFO', '🔍 FBI is investigating the button theft...');
                }, 2000);
                
                setTimeout(() => {
                    addTerminalMessage('SUCCESS', '🛡️ Security upgrade complete! New button deployed!');
                    declineBtn.style.display = 'inline-block';
                    declineBtn.innerHTML = 'Từ chối (Bảo vệ)';
                }, 4000);
                
            } else {
                addTerminalMessage('WARNING', '😅 OK OK, bạn thật sự muốn từ chối à?');
                addTerminalMessage('INFO', '💔 Buồn quá... nhưng mình hiểu mà...');
                addTerminalMessage('SUCCESS', '✅ Đã ghi nhận: Bạn từ chối tham dự (nhưng mình vẫn hope bạn đổi ý!)');
                
                declineBtn.style.display = 'none';
                
                setTimeout(() => {
                    const changedMindBtn = document.createElement('button');
                    changedMindBtn.className = 'button';
                    changedMindBtn.innerHTML = '💚 Tôi đổi ý rồi!';
                    changedMindBtn.onclick = () => {
                        addTerminalMessage('SUCCESS', '🎉 YAY! Cảm ơn bạn đã đổi ý! Welcome back! 🎉');
                        confirmAttendance();
                        changedMindBtn.remove();
                    };
                    document.querySelector('.buttons').appendChild(changedMindBtn);
                }, 2000);
            }
        }

        function addTerminalMessage(type, message, className = '') {
            const terminal = document.querySelector('.terminal');
            const timestamp = new Date().toLocaleTimeString();
            
            const newMessage = document.createElement('div');
            newMessage.className = `command-line ${className}`;
            
            let typeColor = '#00aaff';
            if (type === 'SUCCESS') typeColor = '#00ff00';
            if (type === 'WARNING') typeColor = '#ff9900';
            if (type === 'ERROR') typeColor = '#ff0000';
            
            newMessage.innerHTML = `
                <span class="prompt">[${timestamp.slice(0, 5)}] </span>
                <span style="color: ${typeColor};">${type}</span>
                <span style="margin-left: 10px;">${message}</span>
            `;
            
            terminal.appendChild(newMessage);
            newMessage.scrollIntoView({ behavior: 'smooth' });
        }

        async function submitGuestbook() {
            const name = document.getElementById('guestName').value;
            const message = document.getElementById('guestMessage').value;
            
            if (!name.trim() || !message.trim()) {
                alert('Vui lòng nhập đầy đủ tên và lời nhắn!');
                return;
            }
            
            try {
                const submitBtn = document.querySelector('#guestbook button');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Đang gửi...';
                submitBtn.disabled = true;
                
                const response = await fetch('/api/rsvp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name.trim(),
                        message: message.trim(),
                        status: 'confirmed',
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const terminal = document.querySelector('.terminal');
                    const newOutput = document.createElement('div');
                    newOutput.className = 'command-line';
                    newOutput.innerHTML = `
                        <div style="margin: 20px 0;">
                            <div class="success">✅ Gửi thành công lên server!</div>
                            <div style="color: #ffffff; margin-top: 10px;">
                                <strong style="color: #ffff00;">Tên:</strong> ${name}<br>
                                <strong style="color: #ffff00;">Lời nhắn:</strong> ${message}<br>
                                <strong style="color: #ffff00;">ID:</strong> #${result.guest.id}
                            </div>
                            <div class="info" style="margin-top: 10px;">Cảm ơn bạn đã RSVP! Dữ liệu đã được lưu! 🎉</div>
                        </div>
                    `;
                    terminal.appendChild(newOutput);
                    
                    document.getElementById('guestName').value = '';
                    document.getElementById('guestMessage').value = '';
                    document.getElementById('guestbook').style.display = 'none';
                    
                    newOutput.scrollIntoView({ behavior: 'smooth' });
                    
                } else {
                    throw new Error(result.error || 'Failed to save RSVP');
                }
                
            } catch (error) {
                console.error('Error:', error);
                addTerminalMessage('ERROR', `❌ Lỗi: ${error.message}`, 'terminal-warning');
            } finally {
                const submitBtn = document.querySelector('#guestbook button');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function cancelGuestbook() {
            document.getElementById('guestbook').style.display = 'none';
            document.getElementById('guestName').value = '';
            document.getElementById('guestMessage').value = '';
        }
    </script>
</body>
</html>